---
import Footnote from './Footnote.astro';
import type { FootnoteData } from '../plugins/footnotes';

interface Props {
    footnotes: FootnoteData[];
}

const { footnotes } = Astro.props;
---

{footnotes.length > 0 && (
    <div id="footnotes-container">
        {footnotes.map((fn) => (
            <Footnote id={fn.id} number={fn.number} html={fn.html} />
        ))}
    </div>
)}

<script>
    function positionFootnotes() {
        const footnotesSection = document.querySelector('.footnotes') as HTMLElement;
        if (footnotesSection) {
            footnotesSection.style.display = 'none';
        }

        const container = document.querySelector('#footnotes-container') as HTMLElement;
        if (!container) return;

        const footnoteElements = container.querySelectorAll('.sidebar-footnote') as NodeListOf<HTMLElement>;
        if (footnoteElements.length === 0) return;

        const containerRect = container.getBoundingClientRect();
        let lastBottom = 0;

        footnoteElements.forEach((footnoteEl) => {
            const footnoteId = footnoteEl.dataset.footnoteId;
            if (!footnoteId) return;

            // Find the reference link in the content that points to this footnote
            const refLink = document.querySelector(`a[href="#${footnoteId}"]`) as HTMLElement;
            if (!refLink) return;

            const refRect = refLink.getBoundingClientRect();
            const relativeTop = refRect.top - containerRect.top;

            // Collision detection: must be below previous footnote and inside container
            let top = Math.max(relativeTop, lastBottom + 10);
            top = Math.max(top, 0);

            footnoteEl.style.top = `${top}px`;
            footnoteEl.style.width = '100%';

            lastBottom = top + footnoteEl.offsetHeight;
        });
    }

    function createConnectingLines() {
        const linesContainer = document.querySelector('#footnote-lines-container') as HTMLElement;
        if (!linesContainer) return;

        // Clear any existing lines and circles
        linesContainer.innerHTML = '';

        const layoutRect = linesContainer.getBoundingClientRect();
        const footnoteElements = document.querySelectorAll('.sidebar-footnote') as NodeListOf<HTMLElement>;

        footnoteElements.forEach((footnoteEl) => {
            const footnoteId = footnoteEl.dataset.footnoteId;
            if (!footnoteId) return;

            const refLink = document.querySelector(`a[href="#${footnoteId}"]`) as HTMLElement;
            if (!refLink) return;

            const refRect = refLink.getBoundingClientRect();
            const footnoteRect = footnoteEl.getBoundingClientRect();
            const refStyles = window.getComputedStyle(refLink);

            // Calculate position relative to the layout container
            const lineLeft = refRect.right + 8 - layoutRect.left;
            const lineRight = footnoteRect.left - layoutRect.left;
            const lineTop = refRect.top + refRect.height / 2 - layoutRect.top;

            // Create connecting line
            const line = document.createElement('div');
            line.className = 'footnote-connecting-line';
            line.dataset.footnoteId = footnoteId;
            line.style.left = `${lineLeft}px`;
            line.style.top = `${lineTop}px`;
            line.style.width = `${Math.max(0, lineRight - lineLeft)}px`;
            linesContainer.appendChild(line);

            // Create filled circle with footnote number
            const circle = document.createElement('div');
            circle.className = 'footnote-circle';
            circle.dataset.footnoteId = footnoteId;
            circle.textContent = refLink.textContent;
            circle.style.left = `${refRect.left + refRect.width / 2 - layoutRect.left}px`;
            circle.style.top = `${refRect.top + refRect.height / 2 - layoutRect.top}px`;
            circle.style.fontSize = refStyles.fontSize;
            linesContainer.appendChild(circle);
        });
    }

    function setupHoverHighlighting() {
        const footnoteElements = document.querySelectorAll('.sidebar-footnote') as NodeListOf<HTMLElement>;

        footnoteElements.forEach((footnoteEl) => {
            const footnoteId = footnoteEl.dataset.footnoteId;
            if (!footnoteId) return;

            const refLink = document.querySelector(`a[href="#${footnoteId}"]`) as HTMLElement;
            const line = document.querySelector(`.footnote-connecting-line[data-footnote-id="${footnoteId}"]`) as HTMLElement;
            const circle = document.querySelector(`.footnote-circle[data-footnote-id="${footnoteId}"]`) as HTMLElement;
            if (!refLink) return;

            footnoteEl.addEventListener('mouseenter', () => {
                if (line) line.classList.add('visible');
                if (circle) circle.classList.add('visible');
            });

            footnoteEl.addEventListener('mouseleave', () => {
                if (line) line.classList.remove('visible');
                if (circle) circle.classList.remove('visible');
            });
        });
    }

    function setupMobileFootnotes() {
        const isMobile = window.matchMedia('(max-width: 1023px)').matches;
        if (!isMobile) return;

        let activePopup: HTMLElement | null = null;

        function closePopup() {
            if (activePopup) {
                activePopup.remove();
                activePopup = null;
            }
        }

        // Find all footnote reference links in the content
        const footnoteLinks = document.querySelectorAll('a[href^="#user-content-fn-"]') as NodeListOf<HTMLAnchorElement>;

        footnoteLinks.forEach((link) => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const footnoteId = link.getAttribute('href')?.slice(1);
                if (!footnoteId) return;

                // Find the corresponding sidebar footnote
                const sidebarFootnote = document.querySelector(`.sidebar-footnote[data-footnote-id="${footnoteId}"]`) as HTMLElement;
                if (!sidebarFootnote) return;

                // Close any existing popup
                closePopup();

                // Create popup
                const popup = document.createElement('div');
                popup.className = 'mobile-footnote-popup';
                popup.innerHTML = `<b>${link.textContent}.</b> ${sidebarFootnote.innerHTML.replace(/<b>\d+\.<\/b>\s*/, '')}`;
                document.body.appendChild(popup);
                activePopup = popup;
            });
        });

        // Close popup when tapping outside
        document.addEventListener('click', (e) => {
            if (activePopup && !activePopup.contains(e.target as Node)) {
                closePopup();
            }
        });
    }

    function initFootnotes() {
        const isMobile = window.matchMedia('(max-width: 1023px)').matches;

        if (isMobile) {
            setupMobileFootnotes();
        } else {
            requestAnimationFrame(() => {
                positionFootnotes();
                createConnectingLines();
                setupHoverHighlighting();
            });
        }
    }

    window.addEventListener('load', initFootnotes);
    window.addEventListener('resize', initFootnotes);
    document.addEventListener('astro:page-load', initFootnotes);
</script>

<style>
    #footnotes-container {
        position: relative;
        width: 100%;
    }
</style>
