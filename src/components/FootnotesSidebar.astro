---
import Footnote from './Footnote.astro';
import type { FootnoteData } from '../plugins/footnotes';

interface Props {
    footnotes: FootnoteData[];
}

const { footnotes } = Astro.props;
---

{footnotes.length > 0 && (
    <div id="footnotes-container">
        {footnotes.map((fn) => (
            <Footnote id={fn.id} number={fn.number} html={fn.html} />
        ))}
    </div>
)}

<script>
    function positionFootnotes() {
        const footnotesSection = document.querySelector('.footnotes') as HTMLElement;
        if (footnotesSection) {
            footnotesSection.style.display = 'none';
        }

        const container = document.querySelector('#footnotes-container') as HTMLElement;
        if (!container) return;

        const footnoteElements = container.querySelectorAll('.sidebar-footnote') as NodeListOf<HTMLElement>;
        if (footnoteElements.length === 0) return;

        const containerRect = container.getBoundingClientRect();
        let lastBottom = 0;

        footnoteElements.forEach((footnoteEl) => {
            const footnoteId = footnoteEl.dataset.footnoteId;
            if (!footnoteId) return;

            // Find the reference link in the content that points to this footnote
            const refLink = document.querySelector(`a[href="#${footnoteId}"]`) as HTMLElement;
            if (!refLink) return;

            const refRect = refLink.getBoundingClientRect();
            const relativeTop = refRect.top - containerRect.top;

            // Collision detection: must be below previous footnote and inside container
            let top = Math.max(relativeTop, lastBottom + 10);
            top = Math.max(top, 0);

            footnoteEl.style.top = `${top}px`;
            footnoteEl.style.width = '100%';

            lastBottom = top + footnoteEl.offsetHeight;
        });
    }

    const run = () => {
        requestAnimationFrame(positionFootnotes);
    };

    function setupHoverHighlighting() {
        const footnoteElements = document.querySelectorAll('.sidebar-footnote') as NodeListOf<HTMLElement>;
        let connectingLine: HTMLElement | null = null;
        let activeRefLink: HTMLElement | null = null;
        let activeFootnoteEl: HTMLElement | null = null;
        let scrollTimeout: number | null = null;

        function updateLinePosition() {
            if (!connectingLine || !activeRefLink || !activeFootnoteEl) return;

            const refRect = activeRefLink.getBoundingClientRect();
            const footnoteRect = activeFootnoteEl.getBoundingClientRect();

            const lineLeft = refRect.right + 8;
            const lineRight = footnoteRect.left;
            const lineTop = refRect.top + refRect.height / 2;

            connectingLine.style.left = `${lineLeft}px`;
            connectingLine.style.top = `${lineTop}px`;
            connectingLine.style.width = `${Math.max(0, lineRight - lineLeft)}px`;
        }

        // Hide line while scrolling, recalculate position when done
        window.addEventListener('scroll', () => {
            if (connectingLine) {
                connectingLine.style.display = 'none';
            }

            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }

            scrollTimeout = window.setTimeout(() => {
                if (connectingLine) {
                    updateLinePosition();
                    connectingLine.style.display = '';
                }
            }, 150);
        }, { passive: true });

        footnoteElements.forEach((footnoteEl) => {
            const footnoteId = footnoteEl.dataset.footnoteId;
            if (!footnoteId) return;

            const refLink = document.querySelector(`a[href="#${footnoteId}"]`) as HTMLElement;
            if (!refLink) return;

            footnoteEl.addEventListener('mouseenter', () => {
                refLink.classList.add('footnote-highlighted');
                activeRefLink = refLink;
                activeFootnoteEl = footnoteEl;

                // Create connecting line
                connectingLine = document.createElement('div');
                connectingLine.className = 'footnote-connecting-line';
                document.body.appendChild(connectingLine);

                updateLinePosition();
            });

            footnoteEl.addEventListener('mouseleave', () => {
                refLink.classList.remove('footnote-highlighted');
                activeRefLink = null;
                activeFootnoteEl = null;

                if (connectingLine) {
                    connectingLine.remove();
                    connectingLine = null;
                }
            });
        });
    }

    window.addEventListener('load', run);
    window.addEventListener('resize', run);
    document.addEventListener('astro:page-load', run);
    document.addEventListener('astro:page-load', setupHoverHighlighting);
    window.addEventListener('load', setupHoverHighlighting);
</script>

<style>
    #footnotes-container {
        position: relative;
        width: 100%;
    }
</style>
