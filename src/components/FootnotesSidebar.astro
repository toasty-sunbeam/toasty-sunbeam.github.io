---
import Footnote from './Footnote.astro';
import type { FootnoteData } from '../plugins/footnotes';

interface Props {
    footnotes: FootnoteData[];
}

const { footnotes } = Astro.props;
---

{footnotes.length > 0 && (
    <div id="footnotes-container">
        {footnotes.map((fn) => (
            <Footnote id={fn.id} number={fn.number} html={fn.html} />
        ))}
    </div>
)}

<script>
    function positionFootnotes() {
        const footnotesSection = document.querySelector('.footnotes') as HTMLElement;
        if (footnotesSection) {
            footnotesSection.style.display = 'none';
        }

        const container = document.querySelector('#footnotes-container') as HTMLElement;
        if (!container) return;

        const footnoteElements = container.querySelectorAll('.sidebar-footnote') as NodeListOf<HTMLElement>;
        if (footnoteElements.length === 0) return;

        const containerRect = container.getBoundingClientRect();
        let lastBottom = 0;

        footnoteElements.forEach((footnoteEl) => {
            const footnoteId = footnoteEl.dataset.footnoteId;
            if (!footnoteId) return;

            // Find the reference link in the content that points to this footnote
            const refLink = document.querySelector(`a[href="#${footnoteId}"]`) as HTMLElement;
            if (!refLink) return;

            const refRect = refLink.getBoundingClientRect();
            const relativeTop = refRect.top - containerRect.top;

            // Collision detection: must be below previous footnote and inside container
            let top = Math.max(relativeTop, lastBottom + 10);
            top = Math.max(top, 0);

            footnoteEl.style.top = `${top}px`;
            footnoteEl.style.width = '100%';

            lastBottom = top + footnoteEl.offsetHeight;
        });
    }

    function createConnectingLines() {
        const linesContainer = document.querySelector('#footnote-lines-container') as HTMLElement;
        if (!linesContainer) return;

        // Clear any existing lines
        linesContainer.innerHTML = '';

        const layoutRect = linesContainer.getBoundingClientRect();
        const footnoteElements = document.querySelectorAll('.sidebar-footnote') as NodeListOf<HTMLElement>;

        footnoteElements.forEach((footnoteEl) => {
            const footnoteId = footnoteEl.dataset.footnoteId;
            if (!footnoteId) return;

            const refLink = document.querySelector(`a[href="#${footnoteId}"]`) as HTMLElement;
            if (!refLink) return;

            const refRect = refLink.getBoundingClientRect();
            const footnoteRect = footnoteEl.getBoundingClientRect();

            // Calculate position relative to the layout container
            const lineLeft = refRect.right + 8 - layoutRect.left;
            const lineRight = footnoteRect.left - layoutRect.left;
            const lineTop = refRect.top + refRect.height / 2 - layoutRect.top;

            const line = document.createElement('div');
            line.className = 'footnote-connecting-line';
            line.dataset.footnoteId = footnoteId;
            line.style.left = `${lineLeft}px`;
            line.style.top = `${lineTop}px`;
            line.style.width = `${Math.max(0, lineRight - lineLeft)}px`;
            linesContainer.appendChild(line);
        });
    }

    function setupHoverHighlighting() {
        const footnoteElements = document.querySelectorAll('.sidebar-footnote') as NodeListOf<HTMLElement>;

        footnoteElements.forEach((footnoteEl) => {
            const footnoteId = footnoteEl.dataset.footnoteId;
            if (!footnoteId) return;

            const refLink = document.querySelector(`a[href="#${footnoteId}"]`) as HTMLElement;
            const line = document.querySelector(`.footnote-connecting-line[data-footnote-id="${footnoteId}"]`) as HTMLElement;
            if (!refLink) return;

            footnoteEl.addEventListener('mouseenter', () => {
                refLink.classList.add('footnote-highlighted');
                if (line) line.classList.add('visible');
            });

            footnoteEl.addEventListener('mouseleave', () => {
                refLink.classList.remove('footnote-highlighted');
                if (line) line.classList.remove('visible');
            });
        });
    }

    function initFootnotes() {
        requestAnimationFrame(() => {
            positionFootnotes();
            createConnectingLines();
            setupHoverHighlighting();
        });
    }

    window.addEventListener('load', initFootnotes);
    window.addEventListener('resize', initFootnotes);
    document.addEventListener('astro:page-load', initFootnotes);
</script>

<style>
    #footnotes-container {
        position: relative;
        width: 100%;
    }
</style>
